<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <title>Find the cat!</title>
  <style>
    div#main {
      width: 100%;
      max-width: 640px;
      margin: auto;
    }
    h1 {
      text-align: center;
    }
    canvas {
      width: 100%;
      border: 1px solid black;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/4.6.2/pixi.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
  <script src="sprites.js"></script>
  <script src="helpers.js"></script>
</head>


<body>
  <div id="main">
    <h1>Find the cat!</h1>
  </div>
  <script>

    PIXI.settings.SCALE_MODE = PIXI.SCALE_MODES.NEAREST;
    PIXI.loader
      .add('resources/bunny.json')
      .add('resources/rat.json')
      .add('resources/bird.json')
      .add('resources/snail.json')
      .load(onAssetsLoaded);

    function onAssetsLoaded() {

      function animations() {
        for (var i = 0; i < spritesData.length; i++) {
          var frames = [];
          for (var j = 0; j < spritesData[i].frames.length; j++) {
            frames.push(PIXI.Texture.fromFrame(spritesData[i].frames[j]));
          }
          spritesData[i].animation = frames;
        }
      }

      function sprites(n) {
        var sprites = [];
        for (var i = 0; i < n; i++) {
          var data = _.sample(spritesData);
          var isAnimated = data.animation.length > 1;
          if (!isAnimated) {
            var sprite = new PIXI.Sprite.from(data.animation[0]);
          } else {
            var sprite = new PIXI.extras.AnimatedSprite(data.animation);
            sprite.animationSpeed = 1 / _.random(30, 180);
            sprite.play();
          }
          var p = getRandomPosition(positions, true);
          sprite.x = p.x;
          sprite.y = p.y;
          sprite.anchor.set(0.5, 1);
          sprite.scale.x *= 2;
          sprite.scale.y *= 2;
          if (_.random(0, 1)) {
            sprite.scale.x *= -1;
          }
          if (data.velocity) {
            sprite.vx = data.velocity * sprite.scale.x * -1;
            if (isAnimated) {
              sprite.animationSpeed = data.animVelocity;
            }
          }
          sprites.push(sprite);
        }
        return sprites;

      }

      var app = new PIXI.Application(640, 200, { backgroundColor: 0xeeeeee });
      document.getElementById('main').appendChild(app.view);

      var positions = generatePositionsArray(app.renderer.width - 24, app.renderer.height - 24, 44, 10);
      animations();
      sprites = sprites(40);
      sprites = _.sortBy(sprites, 'y');

      // Draw
      for (var i = 0; i < sprites.length; i++) {
        app.stage.addChild(sprites[i]);
      }

      // Move some sprites
      app.ticker.add(function (delta) {
        for (var i = 0; i < sprites.length; i++) {
          var sprite = sprites[i];
          if (sprite.vx) {
            sprite.x += sprite.vx * delta;
          }
        }
      });

    }

  </script>
</body>

</html>